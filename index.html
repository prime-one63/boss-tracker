<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Boss Tracker Dashboard</title>

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

  <style>
    body { background-color: #f8f9fa; }
    .sidebar {
      height: 100vh;
      background-color: #212529;
      color: #fff;
      position: fixed;
      width: 250px;
      top: 0;
      left: 0;
      padding-top: 20px;
    }
    .sidebar h4 { text-align: center; margin-bottom: 30px; font-weight: 600; }
    .sidebar a {
      color: #adb5bd;
      display: block;
      padding: 10px 20px;
      text-decoration: none;
      border-radius: 6px;
      transition: background 0.2s, color 0.2s;
    }
    .sidebar a:hover, .sidebar a.active { background-color: #495057; color: #fff; }
    .content { margin-left: 250px; padding: 30px; }
    .boss-card {
      border-radius: 12px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      background: white;
      padding: 20px;
      margin-bottom: 15px;
    }
    .countdown { font-size: 1.25rem; font-weight: 600; color: #0d6efd; }
    .toast-container { position: fixed; top: 1rem; right: 1rem; z-index: 2000; }
  </style>
</head>
<body>

  <!-- Sidebar -->
  <div class="sidebar">
    <h4>Boss Tracker</h4>
    <a href="#" id="navDashboard" class="active">Dashboard</a>
    <a href="#" id="navBossList">Boss List</a>
  </div>

  <!-- Toast -->
  <div class="toast-container">
    <div id="saveToast" class="toast align-items-center text-bg-success border-0" role="alert">
      <div class="d-flex">
        <div class="toast-body">✅ Boss saved successfully!</div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
      </div>
    </div>
  </div>

  <!-- Main Content -->
  <div class="content">
    <!-- Dashboard Section -->
    <div id="dashboardSection">
      <h3 class="mb-4">Boss Spawn Dashboard</h3>
      <div id="dashboardCards" class="row gy-3"></div>
    </div>

    <!-- Boss List Section -->
    <div id="bossListSection" style="display:none;">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h3>Boss List Tracker</h3>
        <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#bossModal">+ Add Boss</button>
      </div>

      <div class="card p-3">
        <div class="table-responsive">
          <table id="bossTable" class="table table-hover text-center align-middle">
            <thead class="table-primary">
              <tr>
                <th>Boss</th>
                <th>Hour Spawn</th>
                <th>Last Killed</th>
                <th>Next Spawn</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal for Add/Edit -->
  <div class="modal fade" id="bossModal" tabindex="-1" aria-labelledby="bossModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <form id="bossForm">
          <div class="modal-header">
            <h5 class="modal-title" id="bossModalLabel">Add Boss</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <input type="hidden" id="editKey" />
            <div class="mb-3">
              <label class="form-label">Boss Name</label>
              <input type="text" class="form-control" id="bossName" required />
            </div>
            <div class="mb-3">
              <label class="form-label">Spawn Interval (Hours)</label>
              <input type="number" class="form-control" id="bossHour" min="1" required />
            </div>
            <div class="mb-3">
              <label class="form-label">Last Killed</label>
              <input type="datetime-local" class="form-control" id="lastKilled" required />
            </div>
            <div class="mb-3">
              <label class="form-label">Next Spawn (Auto)</label>
              <input type="datetime-local" class="form-control" id="nextSpawn" readonly />
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="submit" class="btn btn-primary">Save</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Firebase + Logic -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getDatabase, ref, push, set, onValue, update, remove, get } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDZ1qt1QZs5kGmoGgrar_WH330OxRWery4",
      authDomain: "boss-tracker-5488e.firebaseapp.com",
      databaseURL: "https://boss-tracker-5488e-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "boss-tracker-5488e",
      storageBucket: "boss-tracker-5488e.firebasestorage.app",
      messagingSenderId: "285894450263",
      appId: "1:285894450263:web:444e346cd7d50d8a181712",
      measurementId: "G-LB9Z0Y1CL3"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // UI Elements
    const dashboardSection = document.getElementById("dashboardSection");
    const bossListSection = document.getElementById("bossListSection");
    const navDashboard = document.getElementById("navDashboard");
    const navBossList = document.getElementById("navBossList");
    const bossForm = document.getElementById("bossForm");
    const bossModal = new bootstrap.Modal(document.getElementById("bossModal"));
    const bossTable = document.querySelector("#bossTable tbody");
    const toast = new bootstrap.Toast(document.getElementById("saveToast"));
    const dashboardCards = document.getElementById("dashboardCards");

    const bossName = document.getElementById("bossName");
    const bossHour = document.getElementById("bossHour");
    const lastKilled = document.getElementById("lastKilled");
    const nextSpawn = document.getElementById("nextSpawn");
    const editKey = document.getElementById("editKey");

    const ADMIN_TOKEN = "BOSS-ADMIN-2025";
    let isAuthorized = false;

    // --- Navigation ---
    navDashboard.addEventListener("click", () => {
      navDashboard.classList.add("active");
      navBossList.classList.remove("active");
      dashboardSection.style.display = "block";
      bossListSection.style.display = "none";
    });

    navBossList.addEventListener("click", async () => {
      if (!isAuthorized) {
        const entered = prompt("Enter admin access token:");
        if (!entered) {
          alert("❌ Invalid token");
          return;
        }
        try {
          // check token in Firebase: tokens/{entered} == true
          const tokenRef = ref(db, "tokens/" + entered.trim());
          const snap = await get(tokenRef);
          if (!snap.exists() || snap.val() !== true) {
            alert("❌ Invalid token");
            return;
          }
          // token valid
          alert("✅ Access granted!");
          isAuthorized = true;
        } catch (err) {
          console.error("Token check failed:", err);
          alert("❌ Token check error (see console).");
          return;
        }
      }

      navBossList.classList.add("active");
      navDashboard.classList.remove("active");
      dashboardSection.style.display = "none";
      bossListSection.style.display = "block";
    });

    // --- Auto Calculate Next Spawn ---
    function calcNextSpawn() {
      const hours = parseFloat(bossHour.value);
      if (hours && lastKilled.value) {
        const d = new Date(lastKilled.value);
        d.setHours(d.getHours() + hours);
        const local = new Date(d.getTime() - d.getTimezoneOffset() * 60000).toISOString().slice(0,16);
        nextSpawn.value = local;
      }
    }
    bossHour.addEventListener("input", calcNextSpawn);
    lastKilled.addEventListener("input", calcNextSpawn);

    // --- Save Boss ---
    bossForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      const entry = {
        bossName: bossName.value.trim(),
        bossHour: bossHour.value,
        lastKilled: lastKilled.value,
        nextSpawn: nextSpawn.value
      };
      if (editKey.value) {
        await update(ref(db, "bosses/" + editKey.value), entry);
      } else {
        await set(push(ref(db, "bosses")), entry);
      }
      bossForm.reset();
      nextSpawn.value = "";
      editKey.value = "";
      bossModal.hide();
      toast.show();
    });

    // --- Render ---
    onValue(ref(db, "bosses"), (snapshot) => {
      bossTable.innerHTML = "";
      dashboardCards.innerHTML = "";

      snapshot.forEach((child) => {
        const key = child.key;
        const b = child.val();

        // Table
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${b.bossName}</td>
          <td>${b.bossHour} hr</td>
          <td>${b.lastKilled}</td>
          <td>${b.nextSpawn}</td>
          <td>
            <button class="btn btn-warning btn-sm edit-btn" data-id="${key}">Edit</button>
            <button class="btn btn-danger btn-sm delete-btn" data-id="${key}">Delete</button>
          </td>`;
        bossTable.appendChild(tr);

        // Dashboard Card
        const card = document.createElement("div");
        card.className = "col-md-4";
        card.innerHTML = `
          <div class="boss-card">
            <h5>${b.bossName}</h5>
            <p>Next Spawn: <strong>${new Date(b.nextSpawn).toLocaleString()}</strong></p>
            <div class="countdown" id="countdown-${key}">--:--:--</div>
          </div>`;
        dashboardCards.appendChild(card);
      });

      // Edit + Delete
      document.querySelectorAll(".edit-btn").forEach((btn) => {
        btn.addEventListener("click", async () => {
          const snap = await (await import("https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js"))
            .get(ref(db, "bosses/" + btn.dataset.id));
          if (snap.exists()) {
            const b = snap.val();
            bossName.value = b.bossName;
            bossHour.value = b.bossHour;
            lastKilled.value = b.lastKilled;
            nextSpawn.value = b.nextSpawn;
            editKey.value = btn.dataset.id;
            document.getElementById("bossModalLabel").textContent = "Edit Boss";
            bossModal.show();
          }
        });
      });

      document.querySelectorAll(".delete-btn").forEach((btn) => {
        btn.addEventListener("click", async () => {
          if (confirm("Delete this boss?")) await remove(ref(db, "bosses/" + btn.dataset.id));
        });
      });
    });

    // --- Countdown Update ---
    setInterval(() => {
      document.querySelectorAll(".countdown").forEach((el) => {
        const key = el.id.replace("countdown-", "");
        const card = el.closest(".boss-card");
        const nextTimeText = card.querySelector("p strong").textContent;
        const nextTime = new Date(nextTimeText);
        const now = new Date();
        const diff = nextTime - now;

        if (isNaN(diff)) return (el.textContent = "--:--:--");
        if (diff <= 0) {
          el.textContent = "Spawned!";
          el.style.color = "red";
        } else {
          const hrs = Math.floor(diff / 3600000);
          const mins = Math.floor((diff % 3600000) / 60000);
          const secs = Math.floor((diff % 60000) / 1000);
          el.textContent = `${hrs.toString().padStart(2, "0")}:${mins.toString().padStart(2, "0")}:${secs.toString().padStart(2, "0")}`;
        }
      });
    }, 1000);
  </script>
</body>
</html>
