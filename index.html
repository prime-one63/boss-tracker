<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Boss Tracker Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background-color: #f5f6fa; }
    .card { border-radius: 12px; }
    .modal-content { border-radius: 12px; }
  </style>
</head>
<body class="p-4">
  <div class="container">
    <h2 class="mb-4 fw-bold">Boss Spawn Dashboard</h2>

    <div class="d-flex justify-content-end mb-3">
      <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#bossModal">Add Boss</button>
    </div>

    <div id="dashboard"></div>
  </div>

  <!-- Modal for Adding / Editing Boss -->
  <div class="modal fade" id="bossModal" tabindex="-1" aria-labelledby="bossModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="bossModalLabel">Add / Edit Boss</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label for="bossName" class="form-label">Boss Name</label>
            <input type="text" id="bossName" class="form-control">
          </div>
          <div class="mb-3">
            <label for="hourSpawn" class="form-label">Hour Spawn (interval)</label>
            <input type="number" id="hourSpawn" class="form-control" placeholder="Enter hours (e.g. 8)">
          </div>
          <div class="mb-3">
            <label for="lastKilled" class="form-label">Last Killed Time</label>
            <input type="datetime-local" id="lastKilled" class="form-control">
          </div>
          <input type="hidden" id="editKey">
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-primary" id="saveBossBtn">Save</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

  <!-- Firebase SDK -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
    import { getDatabase, ref, onValue, set, remove, update } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-database.js";

    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyDZ1qt1QZs5kGmoGgrar_WH330OxRWery4",
      authDomain: "boss-tracker-5488e.firebaseapp.com",
      databaseURL: "https://boss-tracker-5488e-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "boss-tracker-5488e",
      storageBucket: "boss-tracker-5488e.firebasestorage.app",
      messagingSenderId: "285894450263",
      appId: "1:285894450263:web:444e346cd7d50d8a181712",
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const bossRef = ref(db, 'bosses');

    const dashboard = document.getElementById('dashboard');
    const bossModal = new bootstrap.Modal(document.getElementById('bossModal'));

    // Listen for realtime updates
    onValue(bossRef, (snapshot) => {
      dashboard.innerHTML = '';
      const data = snapshot.val();

      if (data) {
        Object.keys(data).forEach((key) => {
          const boss = data[key];
          const nextSpawnDisplay = boss.nextSpawn ? new Date(boss.nextSpawn).toLocaleString() : '--:--';

          const card = document.createElement('div');
          card.className = 'card p-3 mb-3 shadow-sm';
          card.innerHTML = `
            <h5>${boss.name}</h5>
            <p><strong>Next Spawn:</strong> ${nextSpawnDisplay}</p>
            <div class="d-flex gap-2">
              <button class="btn btn-sm btn-outline-primary" onclick="editBoss('${key}')">Edit</button>
              <button class="btn btn-sm btn-outline-danger" onclick="deleteBoss('${key}')">Delete</button>
            </div>
          `;
          dashboard.appendChild(card);
        });
      } else {
        dashboard.innerHTML = '<p>No bosses added yet.</p>';
      }
    });

    // Add / Save Boss
    document.getElementById('saveBossBtn').addEventListener('click', async () => {
      const name = document.getElementById('bossName').value.trim();
      const hours = parseFloat(document.getElementById('hourSpawn').value);
      const killed = document.getElementById('lastKilled').value;
      const editKey = document.getElementById('editKey').value;

      if (!name || !hours || !killed) {
        alert('Please fill in all fields');
        return;
      }

      const killedDate = new Date(killed);
      const nextSpawn = new Date(killedDate.getTime() + hours * 60 * 60 * 1000).toISOString();

      const data = { name, hourSpawn: hours, lastKilled: killed, nextSpawn };

      if (editKey) {
        await update(ref(db, 'bosses/' + editKey), data);
      } else {
        await set(ref(db, 'bosses/' + name.toLowerCase()), data);
      }

      bossModal.hide();
      clearForm();
    });

    // Edit Boss
    window.editBoss = (key) => {
      const boss = JSON.parse(localStorage.getItem('bossCache'))?.[key];
      if (!boss) return;

      document.getElementById('bossName').value = boss.name;
      document.getElementById('hourSpawn').value = boss.hourSpawn;
      document.getElementById('lastKilled').value = boss.lastKilled;
      document.getElementById('editKey').value = key;
      bossModal.show();
    };

    // Delete Boss
    window.deleteBoss = async (key) => {
      if (confirm('Are you sure you want to delete this boss?')) {
        await remove(ref(db, 'bosses/' + key));
      }
    };

    // Cache snapshot locally for quick access
    onValue(bossRef, (snapshot) => {
      localStorage.setItem('bossCache', JSON.stringify(snapshot.val() || {}));
    });

    function clearForm() {
      document.getElementById('bossName').value = '';
      document.getElementById('hourSpawn').value = '';
      document.getElementById('lastKilled').value = '';
      document.getElementById('editKey').value = '';
    }
  </script>
</body>
</html>
