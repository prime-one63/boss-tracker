<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Boss Spawn Dashboard</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

  <style>
    body { background-color: #f8f9fa; }
    .sidebar {
      height: 100vh;
      background-color: #212529;
      color: #fff;
      position: fixed;
      width: 250px;
      top: 0;
      left: 0;
      padding-top: 20px;
    }
    .sidebar h4 { text-align: center; margin-bottom: 30px; font-weight: 600; }
    .sidebar a {
      color: #adb5bd;
      display: block;
      padding: 10px 20px;
      text-decoration: none;
      border-radius: 6px;
      transition: background 0.2s, color 0.2s;
    }
    .sidebar a:hover, .sidebar a.active { background-color: #495057; color: #fff; }
    .content { margin-left: 250px; padding: 30px; }
    .boss-card {
      border-radius: 12px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      background: white;
      padding: 20px;
      margin-bottom: 15px;
    }
    .countdown { font-size: 1.25rem; font-weight: 600; color: #0d6efd; }
    .toast-container { position: fixed; top: 1rem; right: 1rem; z-index: 2000; }
  </style>
</head>
<body>

  <!-- Sidebar -->
  <div class="sidebar">
    <h4>Cloud 9 Boss Tracker</h4>
    <a href="#" id="navDashboard" class="active">Dashboard</a>
    <a href="#" id="navBossList">Boss List</a>
  </div>

  <!-- Toast -->
  <div class="toast-container">
    <div id="saveToast" class="toast align-items-center text-bg-success border-0" role="alert">
      <div class="d-flex">
        <div class="toast-body">✅ Boss saved successfully!</div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
      </div>
    </div>
  </div>

  <!-- Main Content -->
  <div class="content">
    <div id="dashboardSection">
      <h3 class="mb-4">Boss Spawn Dashboard</h3>
      <div id="dashboardCards" class="row gy-3"></div>
    </div>

    <div id="bossListSection" style="display:none;">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h3>Boss List Tracker</h3>
        <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#bossModal">+ Add Boss</button>
      </div>

      <div class="card p-3">
        <div class="table-responsive">
          <table id="bossTable" class="table table-hover text-center align-middle">
            <thead class="table-primary">
              <tr>
                <th>Boss</th>
                <th>Hour Spawn</th>
                <th>Last Killed Time</th>
                <th>Next Spawn</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal -->
  <div class="modal fade" id="bossModal" tabindex="-1" aria-labelledby="bossModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <form id="bossForm">
          <div class="modal-header">
            <h5 class="modal-title" id="bossModalLabel">Add Boss Entry</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <input type="hidden" id="editKey" />

            <div class="mb-3">
              <label class="form-label">Boss</label>
              <input type="text" class="form-control" id="bossName" required />
            </div>

            <div class="mb-3">
              <label class="form-label">Hour Spawn (interval)</label>
              <input type="number" class="form-control" id="hourSpawn" min="1" required />
            </div>

            <div class="mb-3">
              <label class="form-label">Last Killed Time</label>
              <input type="datetime-local" class="form-control" id="lastKilledTime" required />
            </div>

            <div class="mb-3">
              <label class="form-label">Next Spawn (auto-calculated)</label>
              <input type="datetime-local" class="form-control" id="nextSpawn" readonly />
            </div>
          </div>

          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="submit" class="btn btn-primary">Save</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Firebase + IndexedDB Logic -->
  <script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
  import { getDatabase, ref, push, set, onValue, update, remove } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-database.js";

  // ✅ Fixed Firebase config (correct storageBucket)
  const firebaseConfig = {
    apiKey: "AIzaSyDZ1qt1QZs5kGmoGgrar_WH330OxRWery4",
    authDomain: "boss-tracker-5488e.firebaseapp.com",
    databaseURL: "https://boss-tracker-5488e-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "boss-tracker-5488e",
    storageBucket: "boss-tracker-5488e.appspot.com",
    messagingSenderId: "285894450263",
    appId: "1:285894450263:web:444e346cd7d50d8a181712",
    measurementId: "G-LB9Z0Y1CL3"
  };

  // ✅ Initialize Firebase
  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);
  console.log("✅ Firebase initialized:", app.name);
  console.log("✅ Database connected:", db);

  // DOM references
  const bossForm = document.getElementById("bossForm");
  const bossTableBody = document.querySelector("#bossTable tbody");
  const bossModal = new bootstrap.Modal(document.getElementById("bossModal"));
  const bossNameInput = document.getElementById("bossName");
  const hourSpawnInput = document.getElementById("hourSpawn");
  const lastKilledTimeInput = document.getElementById("lastKilledTime");
  const nextSpawnInput = document.getElementById("nextSpawn");
  const editKeyInput = document.getElementById("editKey");
  const dashboardCards = document.getElementById("dashboardCards");
  const toast = new bootstrap.Toast(document.getElementById("saveToast"));

  const dashboardSection = document.getElementById("dashboardSection");
  const bossListSection = document.getElementById("bossListSection");
  const navDashboard = document.getElementById("navDashboard");
  const navBossList = document.getElementById("navBossList");

  console.log("Boss Tracker loaded. Watching Firebase connection...");

  // ✅ IndexedDB Setup
  const dbPromise = indexedDB.open("BossTrackerDB", 1);
  dbPromise.onupgradeneeded = (event) => {
    const db = event.target.result;
    db.createObjectStore("bosses", { keyPath: "key" });
  };

  function saveLocalBosses(bossArray) {
    const req = indexedDB.open("BossTrackerDB", 1);
    req.onsuccess = (e) => {
      const db = e.target.result;
      const tx = db.transaction("bosses", "readwrite");
      const store = tx.objectStore("bosses");
      store.clear();
      bossArray.forEach((b) => store.put({ key: b.key, val: b.val }));
    };
  }


  function loadLocalBosses(callback) {
    const req = indexedDB.open("BossTrackerDB", 1);
    req.onsuccess = (e) => {
      const db = e.target.result;
      const tx = db.transaction("bosses", "readonly");
      const store = tx.objectStore("bosses");
      const getAll = store.getAll();
      getAll.onsuccess = () => callback(getAll.result.map((b) => ({ key: b.key, val: b.val })));
    };
  }

  // ✅ Navigation
  navDashboard.addEventListener("click", () => {
    navDashboard.classList.add("active");
    navBossList.classList.remove("active");
    dashboardSection.style.display = "block";
    bossListSection.style.display = "none";
  });

  navBossList.addEventListener("click", () => {
    navBossList.classList.add("active");
    navDashboard.classList.remove("active");
    dashboardSection.style.display = "none";
    bossListSection.style.display = "block";
  });

  // ✅ Calculate next spawn time
  function calculateNextSpawn() {
    const hours = parseFloat(hourSpawnInput.value);
    const lastKilledValue = lastKilledTimeInput.value;
    if (!isNaN(hours) && lastKilledValue) {
      const lastKilled = new Date(lastKilledValue);
      const nextSpawn = new Date(lastKilled.getTime() + hours * 60 * 60 * 1000);
      const localISO = new Date(nextSpawn.getTime() - nextSpawn.getTimezoneOffset() * 60000)
        .toISOString().slice(0, 16);
      nextSpawnInput.value = localISO;
    }
  }
  hourSpawnInput.addEventListener("input", calculateNextSpawn);
  lastKilledTimeInput.addEventListener("input", calculateNextSpawn);

  // ✅ Form Submit Handler (Add/Edit)
  bossForm.addEventListener("submit", async (e) => {
    e.preventDefault();
    console.log("🟩 Form submitted");

    const boss = bossNameInput.value.trim();
    const hourSpawn = parseFloat(hourSpawnInput.value);
    const lastKilled = lastKilledTimeInput.value;
    const nextSpawn = nextSpawnInput.value;
    const editKey = editKeyInput.value;

    const entry = { boss, hourSpawn, lastKilled, nextSpawn };

    try {
      if (editKey) {
        await update(ref(db, "bosses/" + editKey), entry);
        console.log("🟨 Updated boss:", editKey);
      } else {
        const newRef = push(ref(db, "bosses"));
        await set(newRef, entry);
        console.log("🟩 Added new boss:", newRef.key);
      }

      bossForm.reset();
      nextSpawnInput.value = "";
      editKeyInput.value = "";
      bossModal.hide();
      toast.show();
    } catch (err) {
      console.error("❌ Error saving boss:", err);
      alert("Error saving boss. Check console for details.");
    }
  });

  // ✅ Render Boss List and Dashboard
  function render(data) {
    bossTableBody.innerHTML = "";
    dashboardCards.innerHTML = "";

    data.forEach((item) => {
      const key = item.key;
      const entry = item.val;

      const row = document.createElement("tr");
      row.innerHTML = `
        <td>${entry.boss}</td>
        <td>${entry.hourSpawn} hr</td>
        <td>${entry.lastKilled}</td>
        <td>${entry.nextSpawn}</td>
        <td>
          <button class="btn btn-sm btn-warning me-1 edit-btn" data-key="${key}">Edit</button>
          <button class="btn btn-sm btn-danger delete-btn" data-key="${key}">Delete</button>
        </td>`;
      bossTableBody.appendChild(row);

      const card = document.createElement("div");
      card.classList.add("col-md-4");
      card.innerHTML = `
        <div class="boss-card">
          <h5>${entry.boss}</h5>
          <p>Next Spawn: <strong>${new Date(entry.nextSpawn).toLocaleString()}</strong></p>
          <div class="countdown" id="countdown-${key}">--:--:--</div>
        </div>`;
      dashboardCards.appendChild(card);
    });

    document.querySelectorAll(".edit-btn").forEach((btn) => {
      btn.addEventListener("click", () => {
        const key = btn.dataset.key;
        const entry = data.find((child) => child.key === key).val();

        document.getElementById("bossModalLabel").textContent = "Edit Boss Entry";
        bossNameInput.value = entry.boss;
        hourSpawnInput.value = entry.hourSpawn;
        lastKilledTimeInput.value = entry.lastKilled;
        nextSpawnInput.value = entry.nextSpawn;
        editKeyInput.value = key;
        bossModal.show();
      });
    });

    document.querySelectorAll(".delete-btn").forEach((btn) => {
      btn.addEventListener("click", async () => {
        const key = btn.dataset.key;
        if (confirm("Delete this boss?")) {
          await remove(ref(db, "bosses/" + key));
          console.log("🟥 Deleted boss:", key);
        }
      });
    });
  }

  // ✅ Real-time sync
  onValue(ref(db, "bosses"), (snapshot) => {
    const data = [];
    snapshot.forEach((child) => {
      data.push({ key: child.key, val: child.val() });
    });
    console.log("📦 Firebase data snapshot:", data);
    render(data);
    saveLocalBosses(data);
  });

  // ✅ Load cached data (fallback)
  loadLocalBosses((cached) => {
    if (cached.length > 0) render(cached);
  });

  // ✅ Countdown update loop
  setInterval(() => {
    document.querySelectorAll(".countdown").forEach((el) => {
      const key = el.id.replace("countdown-", "");
      const card = el.closest(".boss-card");
      const nextTimeText = card.querySelector("p strong").textContent;
      const nextTime = new Date(nextTimeText);
      const now = new Date();

      const diff = nextTime - now;
      if (isNaN(diff)) { el.textContent = "--:--:--"; return; }

      if (diff <= 0) {
        el.textContent = "Spawned!";
        el.style.color = "red";
      } else {
        const hrs = Math.floor(diff / 3600000);
        const mins = Math.floor((diff % 3600000) / 60000);
        const secs = Math.floor((diff % 60000) / 1000);
        el.textContent = `${hrs.toString().padStart(2,"0")}:${mins.toString().padStart(2,"0")}:${secs.toString().padStart(2,"0")}`;
      }
    });
  }, 1000);
</script>
</body>
</html>
